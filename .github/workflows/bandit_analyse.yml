name: Analyse de sÃ©curitÃ© Python avec Bandit

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  bandit_scan:
    name: Analyse du code avec Bandit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Ã‰tape 1 - RÃ©cupÃ©ration du code
        uses: actions/checkout@v4

      - name: ğŸ Ã‰tape 2 - Installation de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Ã‰tape 3 - Installation de Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: ğŸ” Ã‰tape 4 - Analyse du code source avec Bandit
        run: |
          bandit -r . -f json -o rapport_bandit.json
          bandit -r . -f txt -o rapport_bandit.txt
          cat rapport_bandit.txt
          cat rapport_bandit.json

      - name: ğŸš¨ Ã‰tape 5 - VÃ©rification des vulnÃ©rabilitÃ©s critiques
        run: |
          high_count=$(bandit -r . -f json | jq '.results[] | select(.issue_severity=="HIGH")' | wc -l)
          echo "Nombre de vulnÃ©rabilitÃ©s critiques dÃ©tectÃ©es : $high_count"
          if [ "$high_count" -gt 0 ]; then
            echo "âŒ Ã‰chec du pipeline : failles de sÃ©vÃ©ritÃ© HIGH dÃ©tectÃ©es."
            exit 1
          else
            echo "âœ… Aucune faille critique dÃ©tectÃ©e."
          fi
